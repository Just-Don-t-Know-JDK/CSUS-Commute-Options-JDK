<!-- Dane & Ethan -->

<!--
    I think we will probably have a navbar for the entire site, so maybe we include the graph options
    as a jumbotron-form where you can checkbox new commute methods to compare.
    Maybe this can instead just be another navbar that could be vertical on the left and the same form format.
-->
<!doctype html>
<html lang="en">
    <head>
        <!-- Meta Tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <title>Data Analysis</title>

        <style>
            html{ overflow-y: scroll; }
        </style>
    </head>
    <body>

        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #043927;">
            <div class="container">
            <a class="navbar-brand" href="#">Sacramento State Traffic Sustainability</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                  <a class="nav-link" href="/index.html">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#">About</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/Resources.html">Resources & Info</a>
                </li>
              </ul>
            </div>
            </div>
        </nav>

        <nav class="navbar-expand-lg navbar-dark" style="background-color: gold; padding: 10px;">
            <div class="container">
                <form id="option" class="form">

                    <div class="form-group">
                        <label>Cost Comparison type</label>
                        <select id="parent" class="form-control">
                            <option value="sustainability">Sustainability</option>
                            <option value="time">Time</option>
                            <option value="money">Money</option>
                        </select>
                    </div>

                </form>
            </div>
        </nav>
        
        <main class="col bg-faded py-3 mx-auto" style="width: 1200px;">
            <canvas class="my-4 chartjs-render-monitor" id="myChart" width="554" height="233" style="display: block; width: 554px; height: 233px;">
        </main>

        <div class="container" style="background-color: gold;">
            <div class="col-5 mx-auto" style="text-align: center;">
                <h2 id="head1">Sustainability</h2>
                <br>
            </div>
            <div class="col-5 mx-auto" style="text-align: center;">
                <p id="p1">The sustainability of a commute mode represents its impact on the environment. To come to our calculations for each mode, 
                    we took the averages of each mode's miles per gallon alongside your inputted data to determine how much you would on average
                    impact the environment with the given mode.
                </p>
            </div>
        </div>
        
        
        
        <!-- Other Stuff -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <!-- Charts.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script>
            let mpg = window.localStorage.getItem('mpg');
            let insurance = window.localStorage.getItem('insurance');
            let travelInfo = JSON.parse(window.localStorage.getItem('travelInfo'));
            let frequency = window.localStorage.getItem('frequency');
            let userType = window.localStorage.getItem('mode');
            processType();

            // Process some slightly different data for database storage
            let userData = {
                mpg: mpg,
                insurance: insurance,
                distance: Math.round(meterToMile(travelInfo[userType][0]) * 10)/10,
                time: Math.round(((travelInfo[userType][1])/60.0) * 10)/10,
                mode: window.localStorage.getItem('mode')
            };
            // Post user data to server
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            }
            fetch('/userData', options).then(response => {
                console.log(response);
            });

            let money = (insurance*12);                             // How much the user pays yearly in insurance & parking

            function processType() {
                if (userType == 'SOV')
                    userType = 0;
                else if (userType == 'MOV')
                    userType = 0;
                else if (userType == 'Motorcycle')
                    userType = 0;
                else if (userType == 'Transit')
                    userType = 3;
                else if (userType == 'Bike')
                    userType = 2;
                else
                    userType = 1;
            }

            function sustainabilityCalc(mpg, distance, freq) {
                return ((((8887/mpg)*distance*2.0*freq*52.0)/1000)*2.205)/1000  // CO2 emissions in kg converted to lbs then to tons
            }
            
            function meterToMile(meters) {
                return meters*0.000621371192;
            }

            function timeCalc(seconds, freq) {
                return (seconds/3600.0)*freq*52.0*2.0;
            }
            
            // Calculates gas price per year with mpg (value) and commute type (type)
            function extraCost(value, type) {
                return ((meterToMile(travelInfo[type][0]))/value * (frequency*2)) * 52 * 3.1;
            }

            let graphInfo = {
                sustainVals: [
                    Math.round(sustainabilityCalc(mpg, meterToMile(travelInfo[userType][0]), frequency) * 10)/10,   // Users consumption
                    Math.round(sustainabilityCalc(24.2, meterToMile(travelInfo[0][0]), frequency) * 10)/10,         // SOV
                    Math.round(sustainabilityCalc(25.50, meterToMile(travelInfo[0][0]), frequency) * 10)/10,        // MOV
                    Math.round(sustainabilityCalc(44, meterToMile(travelInfo[0][0]), frequency) * 10)/10,           // Motorcycle
                    Math.round(sustainabilityCalc(50, meterToMile(travelInfo[3][0]), frequency) * 10)/10,           // Transit (should pull stats from https://afdc.energy.gov/data/)
                    0,                                                                                              // Bike
                    0                                                                                               // Walking
                    ],
                timeVals: [
                    Math.round(timeCalc(travelInfo[userType][1], frequency)),
                    Math.round(timeCalc(travelInfo[0][1], frequency)),
                    Math.round(timeCalc(travelInfo[0][1], frequency)),
                    Math.round(timeCalc(travelInfo[0][1], frequency)),
                    Math.round(timeCalc(travelInfo[3][1], frequency)),
                    Math.round(timeCalc(travelInfo[2][1], frequency)),
                    Math.round(timeCalc(travelInfo[1][1], frequency))
                ],
                moneyVals: [                                          // All is yearly (Future iterations should pull stats from https://afdc.energy.gov/data/)
                    Math.round(money + extraCost(mpg, userType)),     // user
                    Math.round(money + extraCost(25.1, 0)),           // SOV (sources in google drive)
                    Math.round(money + extraCost(25.5, 0)),           // MOV (TODO: calculate the split)
                    Math.round(money + extraCost(44, 0)),             // Motorcycle
                    500,                                              // Transit (TODO: Transit cost calculations)
                    0,                                                // Bike
                    0                                                 // Walk
                ]
            }

            var ctx = document.getElementById("myChart");
            var myChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: ["Your Values", "Single Occupant Vehicle", "Multi-Occupant Vehicle", "Motorcycle", "Transit", "Bicycle", "Walking"],
                    datasets: [{
                        data: graphInfo.sustainVals,
                        backgroundColor: ["#dad9u","#3e95cd", "#eb4034", "#ebe534", "#34ed4a", "#8d2ded", "#07eded"],
                        barPercentage: 0.5,
                        barThickness: 6,
                        maxBarThickness: 8,
                        minBarLength: 2
                    }]
                },
                options: {
                    legend: {   display: false  },
                    title: {
                        display: true,
                        text: 'Carbon Emissions (tons per year)'
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

            $('#parent').change(function(){
                if ($('#parent option:selected').text() == 'Sustainability') {
                    myChart.options.title.text = 'Carbon Emissions (tons per year)';
                    $("#p1").html(
                        `
                        The sustainability of a commute mode represents its impact on the environment. To come to our calculations for each mode, 
                        we took the averages of each mode's miles per gallon alongside your inputted data to determine how much you would on average
                        impact the environment with the given mode.
                        `
                    );
                }
                else if ($('#parent option:selected').text() == 'Time') {
                    myChart.options.title.text = 'Time Traveled (hours per year)';
                    $("#p1").html(
                        `
                        The time concerns of a commute mode are the amount of time that we predict this commute mode to take in your situation.
                        To calculate this, we used an algorithm to determine the fastest route you would take to get to Sacramento State and how many times
                        you would commute a week and then upscaled the data to a yearly scale.
                        `
                    );
                }
                else if ($('#parent option:selected').text() == 'Money') {
                    myChart.options.title.text = 'Travel Cost (dollars per year)';
                    $("#p1").html(
                        `
                        The money concerns of a commute mode is just how much it will cost you to pay for your typical commute on a yearly scale.
                        `
                    );
                }

                myChart.data.datasets[0].data = getType($('#parent option:selected').text());
                myChart.update();
                $("#head1").html($('#parent option:selected').text());
            });

            function getType(value) {
                if (value == 'Sustainability')
                    return graphInfo.sustainVals;
                else if (value == 'Time')
                    return graphInfo.timeVals;
                else if (value == 'Money')
                    return graphInfo.moneyVals;
            }
        </script>
    </body>
</html>